# Configuration Nginx pour les statistiques GoAccess
# À ajouter dans /etc/nginx/sites-available/magnyfc78.com
#
# Instructions:
# 1. Créer le fichier .htpasswd: sudo htpasswd -c /etc/nginx/.htpasswd admin
# 2. Ajouter ce bloc location dans votre server block existant
# 3. Tester la config: sudo nginx -t
# 4. Recharger Nginx: sudo systemctl reload nginx

# =============================================================================
# CONFIGURATION BASIQUE - Protection par mot de passe
# =============================================================================

# Accès aux statistiques (protégé par mot de passe)
location /stats.html {
    alias /var/www/magny-fc-78/public/stats.html;

    # Protection par mot de passe
    auth_basic "Statistiques - Accès restreint";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # Cache du navigateur
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";

    # Sécurité
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# Alias court /stats -> /stats.html
location = /stats {
    return 301 /stats.html;
}

# =============================================================================
# CONFIGURATION TEMPS RÉEL - WebSocket (optionnel)
# =============================================================================
# Décommenter les blocs ci-dessous pour activer le mode temps réel

# # WebSocket pour GoAccess temps réel
# location /ws {
#     proxy_pass http://127.0.0.1:7890;
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "upgrade";
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#
#     # Timeout WebSocket
#     proxy_read_timeout 86400;
#     proxy_send_timeout 86400;
#
#     # Protection par mot de passe
#     auth_basic "Statistiques - Accès restreint";
#     auth_basic_user_file /etc/nginx/.htpasswd;
# }

# =============================================================================
# CONFIGURATION ALTERNATIVE - Port dédié pour WebSocket
# =============================================================================
# Si vous préférez un port séparé pour le WebSocket temps réel

# upstream goaccess_ws {
#     server 127.0.0.1:7890;
# }
#
# server {
#     listen 7890 ssl;
#     server_name magnyfc78.com;
#
#     ssl_certificate /etc/letsencrypt/live/magnyfc78.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/magnyfc78.com/privkey.pem;
#
#     location / {
#         proxy_pass http://goaccess_ws;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#     }
# }

# =============================================================================
# PROTECTION ADDITIONNELLE (optionnel)
# =============================================================================

# Limiter le rate pour éviter le brute-force sur l'authentification
# À ajouter dans le bloc http de nginx.conf:
# limit_req_zone $binary_remote_addr zone=stats_limit:10m rate=5r/s;
#
# Puis dans le location /stats.html:
# limit_req zone=stats_limit burst=10 nodelay;

# Restreindre par IP (optionnel)
# location /stats.html {
#     allow 192.168.1.0/24;  # Réseau local
#     allow 82.xxx.xxx.xxx;   # Votre IP fixe
#     deny all;
#
#     # ... reste de la config
# }
